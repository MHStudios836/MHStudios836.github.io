// --- assets/js/firebase-init.js (MERGED & FULL) ---

import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
import { 
    getAuth, 
    signInAnonymously,
    setPersistence,
    browserSessionPersistence,
    onAuthStateChanged
} from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js';
import { 
    getFirestore, 
    doc 
} from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';

// 1. ADD THIS IMPORT FOR STORAGE
import { getStorage } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-storage.js';

const firebaseConfig = {
    apiKey: "{{ env.FIREBASE_API_KEY }}",
    authDomain: "{{ env.FIREBASE_AUTH_DOMAIN }}",
    projectId: "{{ env.FIREBASE_PROJECT_ID }}",
    storageBucket: "{{ env.FIREBASE_STORAGE_BUCKET }}",
    messagingSenderId: "{{ env.FIREBASE_MESSAGING_SENDER_ID }}",
    appId: "{{ env.FIREBASE_APP_ID }}",
    measurementId: "{{ env.FIREBASE_MEASUREMENT_ID }}"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// 2. INITIALIZE STORAGE
const storage = getStorage(app);

const appId = firebaseConfig.projectId; 

function getUserDocRef(userId) {
    return doc(db, 'artifacts', appId, 'users', userId, 'user_profile', 'role_data');
}

async function initialAuth() {
    try {
        await setPersistence(auth, browserSessionPersistence);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User is currently authenticated:", user.uid);
            } else {
                console.log("No user detected. Signing in anonymously...");
                await signInAnonymously(auth);
            }
        });
    } catch (error) {
        console.error("Firebase initial authentication failed:", error);
    }
}

initialAuth();

// 3. EXPORT STORAGE ALONG WITH OTHER SERVICES
export { auth, db, storage, appId, getUserDocRef };